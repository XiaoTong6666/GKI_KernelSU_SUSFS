name: Build Kernels

# åˆ†æï¼š
# æ­¤å·¥ä½œæµè´Ÿè´£ç¼–æ’å„ç§ Android ç‰ˆæœ¬çš„ GKI (Generic Kernel Image) å†…æ ¸æ„å»ºã€‚
# å®ƒä½¿ç”¨çŸ©é˜µç­–ç•¥ (matrix strategy) å¹¶è¡Œæ„å»ºå¤šä¸ªå†…æ ¸ç‰ˆæœ¬ã€‚
# ä¸»è¦åŠŸèƒ½åŒ…æ‹¬é›†æˆ Wild KernelSU (WKSU)ã€SUSFS å’Œ Baseband Guard (BBG)ã€‚

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    # æ‰‹åŠ¨è§¦å‘è¾“å…¥å‚æ•°
    inputs:
      release_type:
        description: "Release Type"
        type: choice
        options: [ Actions, Pre-Release, Release ]
        default: Actions
      ksu_commit:
        description: "KSU Commit (optional)"
        type: string
        default: ""
        required: false
      kernel_build_version:
        # æ§åˆ¶è¦æ„å»ºå“ªä¸€ç»„å†…æ ¸ã€‚'a13-5-15' ä¸“é—¨é’ˆå¯¹ Android 13 Kernel 5.15ã€‚
        description: "Kernel Version to Build"
        type: choice
        options:
          - all
          - a13-5-15
        default: a13-5-15
      feature_set:
        # é€‰æ‹©è¦æ‰“å…¥å†…æ ¸çš„åŠŸèƒ½è¡¥ä¸ã€‚é»˜è®¤åŒ…å« WKSU å’Œ SUSFSã€‚
        description: "Feature Set"
        type: choice
        options:
          - WKSU+SUSFS
          - WKSU
          - None
        default: WKSU+SUSFS
  push:
    branches:
      - main

jobs:
  download-dependencies:
    uses: ./.github/workflows/dependencies.yml

  build-a13-5-15:
    # Android 13 - Kernel 5.15 åˆ†æï¼š
    # 1. æ¡ä»¶ï¼šå¦‚æœé€‰æ‹©äº† 'all' æˆ– 'a13-5-15' åˆ™è¿è¡Œã€‚
    # 2. ä¾èµ–ï¼šç­‰å¾… 'download-dependencies' å®Œæˆã€‚
    if: ${{ inputs.kernel_build_version == 'all' || inputs.kernel_build_version == 'a13-5-15' }}
    needs: download-dependencies
    strategy:
      fail-fast: false
      matrix:
        # çŸ©é˜µç­–ç•¥ï¼šä»…ä¿ç•™ç”¨æˆ·è¦æ±‚çš„ 2025-01 ç‰ˆæœ¬ã€‚
        kernel_version:
          - "5.15.170-android13-2025-01"
    # å¯å¤ç”¨å·¥ä½œæµè°ƒç”¨ï¼š
    # å°†å®é™…æ„å»ºé€»è¾‘å§”æ‰˜ç»™ 'build.yml'ã€‚
    # ä¼ é€’çŸ©é˜µä¸­çš„å…·ä½“ç‰ˆæœ¬å’Œå…¨å±€è¾“å…¥ã€‚
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      kernel_version: ${{ matrix.kernel_version }}
      ksu_commit: ${{ inputs.ksu_commit || '' }}
      feature_set: ${{ inputs.feature_set || 'WKSU+SUSFS' }}

  rej:
    if: always()
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    needs:
    - build-a13-5-15
    steps:
    - name: Download Misc Artifacts
      # ä¸‹è½½â€œæ‚é¡¹â€æ„ä»¶ï¼š
      # æ­¤æ­¥éª¤ä¸‹è½½æ‰€æœ‰åŒ¹é… `*-Rejects` æ¨¡å¼çš„æ„å»ºå·¥ä»¶ã€‚
      # è¿™äº›å·¥ä»¶é€šå¸¸åŒ…å«å†…æ ¸è¡¥ä¸åº”ç”¨å¤±è´¥æ—¶ç”Ÿæˆçš„ .rej æ–‡ä»¶ï¼Œç”¨äºåç»­çš„è°ƒè¯•å’Œåˆ†æã€‚
      uses: actions/download-artifact@v5
      with:
        path: ./downloaded-artifacts
        pattern: '*-Rejects'

    - name: Process Reject Artifacts
      # å¤„ç†æ‹’ç» (Reject) å·¥ä»¶ï¼š
      # 1. éå†ä¸‹è½½çš„ rejects æ–‡ä»¶å¤¹ã€‚
      # 2. å°†å®ƒä»¬æ•´ç†åˆ° `aio-rejects` ç›®å½•ä¸­ï¼Œä¿æŒç›®å½•ç»“æ„æ¸…æ™°ã€‚
      # 3. å¦‚æœå‘ç°ä»»ä½•æ‹’ç»æ–‡ä»¶ï¼Œå°†å®ƒä»¬æ‰“åŒ…æˆ `AIO-REJ.zip`ã€‚
      run: |
        mkdir -p aio-rejects
        
        # Iterate over Rejects artifacts in downloaded-artifacts
        for dir in ./downloaded-artifacts/*-Rejects
        do
            # Ensure it is a directory
            [ -d "$dir" ] || continue
            
            dirname=$(basename "$dir")
          # Process each reject artifact
            
            # Get original name (remove -Rejects suffix)
            original_name=${dirname%-Rejects}
            
            mkdir -p "aio-rejects/$original_name"
            
            # Check for patch-rejects folder (legacy structure) or direct contents
            if [ -d "$dir/patch-rejects" ]; then
              # Legacy structure
                cp -r "$dir/patch-rejects/." "aio-rejects/$original_name/"
            else
              # Current structure
                cp -r "$dir/." "aio-rejects/$original_name/"
            fi
        done
        
        # Zip and upload if we found anything
        if [ "$(ls -A aio-rejects)" ]; then
            # Create a single zip of all rejects
            cd aio-rejects
            zip -r -q -9 ../AIO-REJ.zip .
            cd ..
        else
            echo "No rejects found to upload."
        fi

    - name: Upload AIO-REJ Artifact
      # ä¸Šä¼  AIO-REJ å·¥ä»¶ï¼š
      # å°†æ‰“åŒ…å¥½çš„æ‰€æœ‰æ‹’ç»æ–‡ä»¶ (`AIO-REJ.zip`) ä¸Šä¼ ä¸ºå·¥ä½œæµå·¥ä»¶ï¼Œä¾›å¼€å‘è€…ä¸‹è½½æŸ¥çœ‹ã€‚
      uses: actions/upload-artifact@v4
      with:
        name: AIO-REJ
        path: AIO-REJ.zip
        if-no-files-found: ignore

  release:
    # åˆ†æï¼š
    # æ”¶é›†æ‰€æœ‰æˆåŠŸæ„å»ºä»»åŠ¡çš„äº§ç‰©ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª GitHub Releaseã€‚
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.release_type != 'Actions' }}
    permissions:
      contents: write
    needs:
    # å¿…é¡»ç­‰å¾…æ‰€æœ‰å¯èƒ½çš„æ„å»ºä»»åŠ¡å®Œæˆæˆ–è·³è¿‡ã€‚
    - build-a13-5-15

    env:
      GH_TOKEN: ${{ github.token }}
      RELEASE_NAME: "GKI Kernels With WKSU & SUSFS v2.0.0"
      RELEASE_BODY: ""
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}
    steps:
    - name: Validate Selected Builds
      # éªŒè¯æ‰€é€‰æ„å»ºï¼š
      # æ£€æŸ¥ç”¨æˆ·è¯·æ±‚æ„å»ºçš„ç‰¹å®šç‰ˆæœ¬ï¼ˆä¾‹å¦‚ `a13-5-15`ï¼‰æ˜¯å¦æˆåŠŸå®Œæˆã€‚
      # å¦‚æœä»»ä½•é¢„æœŸçš„æ„å»ºä»»åŠ¡å¤±è´¥ï¼Œåˆ™æ­¤æ­¥éª¤å¤±è´¥ï¼Œé˜»æ­¢å‘å¸ƒä¸å®Œæ•´çš„ Releaseã€‚
      run: |
        set -euo pipefail

        failed=0
        current_type="${{ inputs.kernel_build_version }}"

        check_selected() {
          local target="$1"
          local job_name="$2"
          local result="$3"
          
          if [[ "$current_type" == "all" || "$current_type" == "$target" ]]; then
            if [[ "$result" != "success" ]]; then
              echo "Required job $job_name did not succeed (result: $result)"
              failed=1
            fi
          fi
        }

        check_selected "a13-5-15" "build-a13-5-15" "${{ needs.build-a13-5-15.result }}"

        if [[ "$failed" -ne 0 ]]; then
          exit 1
        fi

    - name: Free Disk Space
      # é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼š
      # ç§»é™¤ä¸å¿…è¦çš„é¢„è£…è½¯ä»¶ï¼ˆå¦‚ Android SDK, .NET, Docker é•œåƒç­‰ï¼‰ä»¥è…¾å‡ºç©ºé—´å¤„ç†å¤§å‹æ„å»ºå·¥ä»¶ã€‚
      if: true
      uses: endersonmenezes/free-disk-space@v3  # Use @main for latest, @v3 for stable
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
        remove_packages_one_command: true
        remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"
        rm_cmd: "rmz"  # Use 'rmz' for faster deletion (default: 'rm')
        rmz_version: "3.1.1"  # Required when rm_cmd is 'rmz'
        testing: false

    - name: Checkout code
      # æ£€å‡ºä»£ç ï¼š
      # æ‹‰å–å½“å‰ä»“åº“çš„ä»£ç ï¼Œä»¥ä¾¿åç»­æ­¥éª¤å¯ä»¥è®¿é—®è„šæœ¬å’Œæ¨¡æ¿æ–‡ä»¶ã€‚
      uses: actions/checkout@v4

    - name: Generate New Tag
      # ç”Ÿæˆæ–°æ ‡ç­¾ (Tag)ï¼š
      # åŸºäºç°æœ‰çš„ Git æ ‡ç­¾ç”Ÿæˆä¸€ä¸ªæ–°çš„å‘å¸ƒç‰ˆæœ¬å·ã€‚
      # é€»è¾‘é€šå¸¸æ˜¯é€’å¢ä¿®è®¢ç‰ˆæœ¬å· (Revision)ï¼Œä¾‹å¦‚ä» `v1.0-r1` å¢åŠ åˆ° `v1.0-r2`ã€‚
      id: tag
      if: inputs.release_type != 'Actions'
      run: |
        LATEST_TAG=$(gh api repos/${{ github.repository }}/tags --jq '.[0].name' 2>/dev/null || echo "v0.0.0")
        if [[ -z "$LATEST_TAG" || "$LATEST_TAG" == "null" ]]; then
          LATEST_TAG="v0.0.0"
        fi
        
        if [[ "$LATEST_TAG" =~ ^(.*)-r([0-9]+)$ ]]; then
          VERSION="${BASH_REMATCH[1]}"
          REV="${BASH_REMATCH[2]}"
          NEW_REV=$((REV + 1))
          NEW_TAG="${VERSION}-r${NEW_REV}"
        else
          NEW_TAG="${LATEST_TAG}-r1"
        fi
        
        echo "Latest tag: $LATEST_TAG"
        echo "New tag: $NEW_TAG"
        echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV
        echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

    - name: Set release body
      # è®¾ç½® Release è¯´æ˜ï¼š
      # ç”Ÿæˆå‘å¸ƒè¯´æ˜æ–‡æ¡£ (release_body.md)ã€‚
      # åŒ…å«äº†å…è´£å£°æ˜ã€åŠŸèƒ½åˆ—è¡¨ï¼ˆWKSU, SUSFS, BBG ç­‰ï¼‰ã€ç‰ˆæœ¬è¯´æ˜ä»¥åŠç›¸å…³é¡¹ç›®çš„é“¾æ¥ã€‚
      run: |
        cat << 'EOF' > release_body.md

        !!THIS RELEASE IS A TESTING RELEASE!!

        **IMPORTANT DISCLAIMER**
        This software is provided for testing and educational purposes only. Use at your own risk.
        The developers are not responsible for any damage, data loss, or issues that may occur.
        Please ensure you have proper backups before installation.

        ğŸ”¹ Normal 
        - Default kernel configuration 
        - Standard kernel module loading behavior 
        - Recommended for most users 

        ğŸ”¹ Bypass 
        - Includes module check bypass modifications 
        - What are kernel modules? Kernel modules are pieces of code that can be loaded into the kernel at runtime to extend functionality (like device drivers, filesystem support, etc.). These are different from KernelSU/Magisk modules. 
        - The Problem: Sometimes when installing a custom kernel, the device tries to load a kernel module that fails due to version mismatches, missing dependencies, or signature verification issues. This can cause boot failures or device instability. 
        - The Solution: This version changes one line from false to true to force load the kernel module, bypassing the failure check that would normally prevent loading.

        âš ï¸ **IMPORTANT: If you are using a Bypass kernel, please create a GitHub issue!**
        We are now building Bypass kernels on-demand to reduce build time and clutter. If you need a Bypass kernel for your device, please:
        1. Create a GitHub issue using the "Bypass Kernel Report" template
        2. Include: kernel version, device model, Android version, and any issues/observations
        3. Message me on Telegram after creating the issue
        I will prioritize and release a new Bypass build ASAP based on your feedback. This helps us understand which devices need Bypass kernels and build only what's needed!

        Features:
        -> Wild KSU Manager Support
        -> SUSFS à¶ v2.0.0
        -> SUSFS Inline Hooks
        -> Ptrace Patch Support for Older Kernels (<5.16) (Disabled for testing)
        -> IPSet Support for Advanced Network Filtering (Disabled for testing, please msg me if you need it)
        -> Wireguard Support 
        -> BBR v1 Support (Disabled for testing, please msg me if you need it)
        -> BBG: https://github.com/vc-teahouse/Baseband-guard (Disabled for testing, will be enabled in the future)

        ğŸ”¹ BBG (Baseband-guard)
        - A lightweight LSM (Linux Security Module) for Android kernel
        - Blocks unauthorized writes to critical partitions/device nodes
        - Prevents malicious tampering with baseband and boot chain
        - Kernel-level protection via LSM hooks
        - Reduces risk of soft-brick/hard-brick issues

        Kernel Flasher:
        -> https://github.com/fatalcoder524/KernelFlasher/

        Manager:
        -> Wild KSU Manager: https://github.com/WildKernels/Wild_KSU

        Module: 
        -> https://github.com/sidex15/ksu_module_susfs

        !!THIS RELEASE IS A TESTING RELEASE!!
        EOF

    - name: Create GitHub Release
      # åˆ›å»º GitHub Releaseï¼š
      # ä½¿ç”¨ `gh release create` å‘½ä»¤ï¼ŒåŸºäºå‰é¢ç”Ÿæˆçš„æ ‡ç­¾å’Œè¯´æ˜æ–‡æ¡£ï¼Œåœ¨ GitHub ä¸Šæ­£å¼åˆ›å»ºä¸€ä¸ª Releaseã€‚
      run: |
        PRERELEASE_FLAG=""
        if [ "${{ inputs.release_type }}" == "Pre-Release" ]; then
          PRERELEASE_FLAG="--prerelease"
        fi

        # Create GitHub release
        gh release create "$NEW_TAG" \
          --title "$RELEASE_NAME" \
          --notes-file release_body.md \
          --target "${{ github.sha }}" \
          $PRERELEASE_FLAG

    - name: Download Artifacts
      # ä¸‹è½½å·¥ä»¶ï¼š
      # ä¸‹è½½æ‰€æœ‰ `*-AnyKernel3` å·¥ä»¶ã€‚è¿™äº›æ˜¯åœ¨æ„å»ºé˜¶æ®µç”Ÿæˆçš„åˆ·æœºåŒ…æ–‡ä»¶å¤¹ã€‚
      uses: actions/download-artifact@v5
      with:
        path: ./downloaded-artifacts
        pattern: '*-AnyKernel3'

    - name: Upload Release Assets
      # ä¸Šä¼ å‘å¸ƒèµ„æºï¼š
      # 1. éå†ä¸‹è½½çš„ AnyKernel3 æ–‡ä»¶å¤¹ã€‚
      # 2. å°†æ¯ä¸ªæ–‡ä»¶å¤¹å‹ç¼©ä¸º ZIP æ–‡ä»¶ã€‚
      # 3. å°†è¿™äº› ZIP æ–‡ä»¶ä¸Šä¼ åˆ°åˆšæ‰åˆ›å»ºçš„ GitHub Release ä¸­ï¼Œä½œä¸ºç”¨æˆ·å¯ä¸‹è½½çš„åˆ·æœºåŒ…ã€‚
      run: |
        shopt -s nullglob
        mapfile -t anykernel_dirs < <(find ./downloaded-artifacts -maxdepth 2 -type d -name '*-AnyKernel3' -print)

        for dir in "${anykernel_dirs[@]}"; do
          artifact_name=$(basename "$dir")
          # Create zip for each artifact
          (cd "$dir" && zip -r -q -9 "$GITHUB_WORKSPACE/${artifact_name}.zip" ./*) &
        done
        wait

        for dir in "${anykernel_dirs[@]}"; do
          artifact_name=$(basename "$dir")
          # Upload release asset
          gh release upload "$NEW_TAG" "$GITHUB_WORKSPACE/${artifact_name}.zip" --clobber
        
  notify:
    runs-on: ubuntu-latest
    needs: release
    if: ${{ always() && (inputs.release_type == 'Actions' || needs.release.result == 'success') }}
    permissions:
      contents: read
      actions: read
    steps:
      - name: Free Disk Space
        # é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼š
        # å†æ¬¡æ¸…ç†ç¯å¢ƒï¼Œè™½ç„¶åœ¨ notify é˜¶æ®µå¯èƒ½ä¸æ˜¯ä¸¥æ ¼å¿…è¦çš„ï¼Œä½†ä¿æŒå¥½ä¹ æƒ¯ã€‚
        uses: endersonmenezes/free-disk-space@v3
        with:
          remove_android: true
          remove_dotnet: true
          remove_haskell: true
          remove_tool_cache: true
          remove_swap: true
          remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
          remove_packages_one_command: true
          remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"
          rm_cmd: "rmz"
          rmz_version: "3.1.1"
          testing: false

      - name: Send Telegram Notification
        # å‘é€ Telegram é€šçŸ¥ï¼š
        # è°ƒç”¨ `telegram-notify` actionï¼Œå°†æ„å»ºå’Œå‘å¸ƒç»“æœå‘é€åˆ°æŒ‡å®šçš„ Telegram é¢‘é“æˆ–ç¾¤ç»„ã€‚
        uses: ./.github/actions/telegram-notify
        with:
          release_type: ${{ inputs.release_type }}
          new_tag: ${{ needs.release.outputs.new_tag }}
          release_result: ${{ needs.release.result }}
          telegram_bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          telegram_chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          telegram_topic_id: ${{ secrets.TELEGRAM_TOPIC_ID_GKI }}
          telegram_user_id: ${{ secrets.TELEGRAM_USER_ID }}